name: 🚀 Deploy to Azure Functions (Windows-Friendly)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest  # 👈 Ensures PowerShell-compatible environment

    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 🐍 Log Python Version
        shell: pwsh
        run: |
          python --version
          Get-Command python

      - name: 📦 Install dependencies to .python_packages
        shell: pwsh
        run: |
          Write-Host "Installing requirements to .python_packages..."
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"
          Get-ChildItem -Path ".python_packages/lib/site-packages"

      - name: 🗂️ Create ZIP Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path build -Force
          Copy-Item -Recurse -Path IntradayAlert,shared,host.json,requirements.txt,.python_packages -Destination build
          Compress-Archive -Path build\* -DestinationPath function.zip
          Write-Host "Deployment ZIP Contents:"
          Expand-Archive -Path function.zip -DestinationPath preview -Force
          Get-ChildItem -Recurse -Path preview

      - name: 🚀 Deploy using Publish Profile
        uses: Azure/functions-action@v1
        with:
          app-name: QuantBot2025
          package: function.zip
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}

      - name: ✅ Deployment Complete
        shell: pwsh
        run: |
          Write-Host "✅ QuantBot MVP deployed successfully!"
